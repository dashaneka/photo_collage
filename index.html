<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Collage Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'inter', sans-serif;
        }
        /* custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* updated style for collage items */
        .collage-item {
            overflow: hidden;
            position: relative;
            background-color: #e2e8f0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            touch-action: none; /* Prevents default browser actions on touch like scrolling */
            cursor: grab;
            transition: box-shadow 0.2s ease-in-out;
        }
        .collage-item.is-dragging, .collage-item:active {
            cursor: grabbing;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.6); /* Highlight when dragging */
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- controls panel -->
        <aside class="w-full lg:w-80 xl:w-96 bg-white p-6 shadow-lg overflow-y-auto">
            <div class="space-y-8">
                <header>
                    <h1 class="text-2xl font-bold text-slate-900">Photo Collage Maker</h1>
                    <p class="text-sm text-slate-500 mt-1">Create and customize your collages.</p>
                </header>

                <!-- upload section -->
                <div>
                    <label for="image-upload" class="cursor-pointer w-full inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                        </svg>
                        Add Images
                    </label>
                    <input id="image-upload" type="file" class="hidden" multiple accept="image/*">
                    <p class="text-xs text-slate-400 mt-2 text-center">Select one or more images to start.</p>
                </div>

                <!-- layout selection -->
                <div>
                    <h3 class="text-base font-semibold text-slate-900 mb-3">Choose Layout</h3>
                    <div id="layout-options" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-3 gap-3">
                        <!-- layout buttons will be injected here by js -->
                    </div>
                </div>

                <!-- Aspect Ratio Selection -->
                <div>
                    <h3 class="text-base font-semibold text-slate-900 mb-3">Aspect Ratio</h3>
                    <div id="aspect-ratio-options" class="grid grid-cols-5 gap-2">
                        <!-- Buttons injected by JS -->
                    </div>
                </div>

                <!-- customization section -->
                <div>
                    <h3 class="text-base font-semibold text-slate-900 mb-3">Customize</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="spacing-slider" class="block text-sm font-medium leading-6 text-slate-700">Spacing</label>
                            <input id="spacing-slider" type="range" min="0" max="50" value="8" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label for="radius-slider" class="block text-sm font-medium leading-6 text-slate-700">Corners</label>
                            <input id="radius-slider" type="range" min="0" max="100" value="12" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label for="color-picker" class="block text-sm font-medium leading-6 text-slate-700">Background Color</label>
                            <input id="color-picker" type="color" value="#f1f5f9" class="w-full h-10 border-0 rounded-md cursor-pointer">
                        </div>
                        <!-- New Image Quality Slider -->
                        <div>
                            <div class="flex justify-between items-center">
                                <label for="scale-slider" class="block text-sm font-medium leading-6 text-slate-700">Image Quality</label>
                                <span id="scale-value" class="text-sm font-medium text-slate-500">3x</span>
                            </div>
                            <input id="scale-slider" type="range" min="1" max="5" value="3" step="0.5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>

                <!-- download button -->
                <div class="pt-4 border-t border-slate-200">
                     <button id="download-btn" class="w-full inline-flex items-center justify-center rounded-md bg-emerald-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Download Collage
                    </button>
                </div>
            </div>
        </aside>

        <!-- collage preview area -->
        <main class="flex-1 flex items-center justify-center p-4 md:p-8 bg-slate-200">
             <div id="collage-wrapper" class="w-full max-w-4xl transition-all duration-300">
                <div id="collage-container" class="w-full h-full flex items-center justify-center bg-slate-100 rounded-lg shadow-inner overflow-hidden">
                    <div id="placeholder" class="text-center text-slate-500 p-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium">No images added</h3>
                        <p class="mt-1 text-sm text-slate-500">Upload some photos to get started!</p>
                    </div>
                </div>
             </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const imageUpload = document.getElementById('image-upload');
            const collageContainer = document.getElementById('collage-container');
            const placeholder = document.getElementById('placeholder');
            const layoutOptionsContainer = document.getElementById('layout-options');
            const aspectRatioOptionsContainer = document.getElementById('aspect-ratio-options');
            const spacingSlider = document.getElementById('spacing-slider');
            const radiusSlider = document.getElementById('radius-slider');
            const colorPicker = document.getElementById('color-picker');
            const downloadBtn = document.getElementById('download-btn');
            const collageWrapper = document.getElementById('collage-wrapper');
            // New elements for scale control
            const scaleSlider = document.getElementById('scale-slider');
            const scaleValue = document.getElementById('scale-value');

            // App state
            let uploadedImages = [];
            let imageTransforms = []; 
            let activeLayoutKey = 'grid-2x2';
            let activeAspectRatio = 'aspect-[4/3]'; // Default

            const layouts = {
                'grid-2x1': { name: '2 Side by Side', cells: 2, class: 'grid-cols-2 grid-rows-1', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v18H3V3m10 0h8v18h-8V3z"/></svg>` },
                'grid-1x2': { name: '2 Over Under', cells: 2, class: 'grid-cols-1 grid-rows-2', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v8H3V3m0 10h18v8H3v-8z"/></svg>` },
                'grid-3x1': { name: '3 Columns', cells: 3, class: 'grid-cols-3 grid-rows-1', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h6v18H3V3m7 0h6v18h-6V3m7 0h6v18h-6V3z"/></svg>` },
                'mosaic-3-top': { name: '1 Top, 2 Bottom', cells: 3, class: 'grid-cols-2 grid-rows-2', spans: ['col-span-2', '', ''], icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v8H3V3m0 10h8v8H3v-8m10 0h8v8h-8v-8z"/></svg>` },
                'mosaic-3-bottom': { name: '2 Top, 1 Bottom', cells: 3, class: 'grid-cols-2 grid-rows-2', spans: ['', '', 'col-span-2'], icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3m10 0h8v8h-8V3m-10 10h18v8H3v-8z"/></svg>` },
                'grid-2x2': { name: '4 Grid', cells: 4, class: 'grid-cols-2 grid-rows-2', icon: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3,3v8h8V3H3z M9,9H5V5h4V9z M3,13v8h8v-8H3z M9,19H5v-4h4V19z M13,3v8h8V3H13z M19,9h-4V5h4V9z M13,13v8h8v-8H13z M19,19h-4v-4h4V19z"/></svg>` },
                'mosaic-1': { name: 'Mosaic 1', cells: 3, class: 'grid-cols-3 grid-rows-2', spans: ['col-span-2 row-span-2', '', ''], icon: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3,3v18h18V3H3z M13,19H5v-8h8V19z M19,19h-4V5h4V19z M13,9H5V5h8V9z"/></svg>`},
                'mosaic-2': { name: 'Mosaic 2', cells: 4, class: 'grid-cols-2 grid-rows-2', spans: ['', 'row-span-2', ''], icon: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3,3v18h18V3H3z M9,19H5v-8h4V19z M19,19h-8v-8h8V19z M19,9h-8V5h8V9z M9,9H5V5h4V9z"/></svg>`},
            };
             const aspectRatios = {
                'square': { label: '1:1', class: 'aspect-square' },
                'standard': { label: '4:3', class: 'aspect-[4/3]' },
                'portrait': { label: '3:4', class: 'aspect-[3/4]' },
                'widescreen': { label: '16:9', class: 'aspect-video' },
                'story': { label: '9:16', class: 'aspect-[9/16]' },
            };

            const initLayoutButtons = () => {
                Object.keys(layouts).forEach((key) => {
                    const layout = layouts[key];
                    const button = document.createElement('button');
                    button.innerHTML = layout.icon;
                    button.className = `p-2 rounded-lg border-2 transition-colors ${key === activeLayoutKey ? 'bg-indigo-100 border-indigo-500' : 'border-slate-300 hover:border-indigo-400'}`;
                    button.dataset.layout = key;
                    button.title = layout.name;
                    button.onclick = () => {
                        activeLayoutKey = key;
                        document.querySelectorAll('#layout-options button').forEach(btn => {
                            btn.classList.remove('bg-indigo-100', 'border-indigo-500');
                            btn.classList.add('border-slate-300', 'hover:border-indigo-400');
                        });
                        button.classList.add('bg-indigo-100', 'border-indigo-500');
                        button.classList.remove('border-slate-300', 'hover:border-indigo-400');
                        renderCollage();
                    };
                    layoutOptionsContainer.appendChild(button);
                });
            };

            const initAspectRatioButtons = () => {
                Object.keys(aspectRatios).forEach(key => {
                    const ratio = aspectRatios[key];
                    const button = document.createElement('button');
                    button.textContent = ratio.label;
                    button.className = `p-2 text-sm rounded-lg border-2 transition-colors ${ratio.class === activeAspectRatio ? 'bg-indigo-100 border-indigo-500 text-indigo-700 font-semibold' : 'border-slate-300 hover:border-indigo-400'}`;
                    button.dataset.ratioClass = ratio.class;

                    button.onclick = () => {
                        activeAspectRatio = ratio.class;
                        document.querySelectorAll('#aspect-ratio-options button').forEach(btn => {
                            btn.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-700', 'font-semibold');
                            btn.classList.add('border-slate-300', 'hover:border-indigo-400');
                        });
                        button.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-700', 'font-semibold');
                        button.classList.remove('border-slate-300', 'hover:border-indigo-400');
                        applyAspectRatio();
                    };
                    aspectRatioOptionsContainer.appendChild(button);
                });
            };

             const applyAspectRatio = () => {
                Object.values(aspectRatios).forEach(ratio => collageWrapper.classList.remove(ratio.class));
                collageWrapper.classList.add(activeAspectRatio);
            };

            const applyStyles = () => {
                const spacing = spacingSlider.value;
                const radius = radiusSlider.value;
                const bgColor = colorPicker.value;

                collageContainer.style.gap = `${spacing}px`;
                collageContainer.style.padding = `${spacing}px`;
                collageContainer.style.borderRadius = `${radius}px`;
                collageContainer.style.backgroundColor = bgColor;
                collageWrapper.parentElement.style.backgroundColor = bgColor;

                document.querySelectorAll('.collage-item').forEach(item => {
                    item.style.borderRadius = `${radius}px`;
                });
            };

            const renderCollage = () => {
                collageContainer.innerHTML = '';
                if (uploadedImages.length === 0) {
                    collageContainer.appendChild(placeholder);
                    collageContainer.className = 'w-full h-full flex items-center justify-center bg-slate-100 rounded-lg shadow-inner overflow-hidden';
                    downloadBtn.disabled = true;
                    return;
                }
                
                downloadBtn.disabled = false;
                placeholder.remove();
                
                const layoutInfo = layouts[activeLayoutKey];
                collageContainer.className = 'w-full h-full grid overflow-hidden transition-all duration-300';
                collageContainer.classList.add(...layoutInfo.class.split(' '));
                
                imageTransforms = Array(layoutInfo.cells).fill(null).map(() => ({ zoom: 1, posX: 50, posY: 50 }));

                for(let i = 0; i < layoutInfo.cells; i++) {
                    const item = document.createElement('div');
                    item.className = 'collage-item';
                    item.dataset.index = i;
                    
                    if(layoutInfo.spans && layoutInfo.spans[i]) {
                         item.classList.add(...layoutInfo.spans[i].split(' '));
                    }
                    
                    const imageUrl = uploadedImages[i % uploadedImages.length];
                    item.style.backgroundImage = `url('${imageUrl}')`;
                    
                    collageContainer.appendChild(item);
                    updateItemTransform(item, i);
                }
                
                applyStyles();
            };
            
            const updateItemTransform = (item, index) => {
                const transform = imageTransforms[index];
                item.style.backgroundSize = `${transform.zoom * 100}%`;
                item.style.backgroundPosition = `${transform.posX}% ${transform.posY}%`;
            };

            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const newImages = [];
                const readers = files.map(file => {
                    return new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            newImages.push(event.target.result);
                            resolve();
                        };
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(readers).then(() => {
                    uploadedImages = newImages;
                    renderCollage();
                });
            };

            const generateFilename = () => {
                const prefix = 'rjcollage';
                const chars = 'abcdefghijklmnopqrstuvwxyz';
                let randomChars = '';
                for (let i = 0; i < 4; i++) {
                    randomChars += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return `${prefix}${randomChars}.png`;
            };
            
            const downloadCollage = () => {
                const btnOriginalText = downloadBtn.innerHTML;
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...`;

                const selectedScale = parseFloat(scaleSlider.value);

                html2canvas(collageContainer, {
                    backgroundColor: colorPicker.value,
                    scale: selectedScale,
                    allowTaint: true,
                    useCORS: true,
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = generateFilename();
                    link.href = canvas.toDataURL('image/png');
                    
                    // This method ensures downloads work on mobile devices
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                }).catch(err => {
                    console.error('Oops, something went wrong!', err);
                    alert('Could not generate image. It might be too large for your device. Try a lower quality setting.');
                }).finally(() => {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = btnOriginalText;
                });
            };
            
            // --- Interaction Logic ---
            let activeItem = null;
            let isDragging = false;
            let startPos = { x: 0, y: 0 };
            let initialBgPos = { x: 0, y: 0 };
            let initialPinchDistance = 0;

            const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

            collageContainer.addEventListener('mousedown', e => {
                if (e.target.classList.contains('collage-item')) {
                    isDragging = true;
                    activeItem = e.target;
                    activeItem.classList.add('is-dragging');
                    const index = parseInt(activeItem.dataset.index, 10);
                    const transform = imageTransforms[index];
                    
                    startPos = { x: e.clientX, y: e.clientY };
                    initialBgPos = { x: transform.posX, y: transform.posY };
                }
            });

            collageContainer.addEventListener('touchstart', e => {
                if (e.target.classList.contains('collage-item')) {
                    activeItem = e.target;
                    const index = parseInt(activeItem.dataset.index, 10);
                    
                    if (e.touches.length === 1) {
                        isDragging = true;
                        activeItem.classList.add('is-dragging');
                        const transform = imageTransforms[index];
                        startPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                        initialBgPos = { x: transform.posX, y: transform.posY };
                    } else if (e.touches.length === 2) {
                        isDragging = false;
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        initialPinchDistance = Math.sqrt(dx * dx + dy * dy);
                    }
                }
            });

            document.addEventListener('mousemove', e => {
                if (!isDragging || !activeItem) return;
                e.preventDefault();

                const index = parseInt(activeItem.dataset.index, 10);
                const transform = imageTransforms[index];
                if (transform.zoom <= 1) return;

                const dx = e.clientX - startPos.x;
                const dy = e.clientY - startPos.y;
                
                const rect = activeItem.getBoundingClientRect();
                const sensitivityX = 100 / (rect.width * (transform.zoom - 1));
                const sensitivityY = 100 / (rect.height * (transform.zoom - 1));
                
                transform.posX = clamp(initialBgPos.x - dx * sensitivityX, 0, 100);
                transform.posY = clamp(initialBgPos.y - dy * sensitivityY, 0, 100);
                
                updateItemTransform(activeItem, index);
            });

             document.addEventListener('touchmove', e => {
                if (!activeItem) return;
                e.preventDefault();

                const index = parseInt(activeItem.dataset.index, 10);
                const transform = imageTransforms[index];

                if (e.touches.length === 1 && isDragging) {
                    if (transform.zoom <= 1) return;
                    const dx = e.touches[0].clientX - startPos.x;
                    const dy = e.touches[0].clientY - startPos.y;
                    const rect = activeItem.getBoundingClientRect();
                    const sensitivityX = 100 / (rect.width * (transform.zoom - 1));
                    const sensitivityY = 100 / (rect.height * (transform.zoom - 1));

                    transform.posX = clamp(initialBgPos.x - dx * sensitivityX, 0, 100);
                    transform.posY = clamp(initialBgPos.y - dy * sensitivityY, 0, 100);
                    updateItemTransform(activeItem, index);

                } else if (e.touches.length === 2 && initialPinchDistance > 0) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const newPinchDistance = Math.sqrt(dx * dx + dy * dy);
                    const zoomFactor = newPinchDistance / initialPinchDistance;

                    transform.zoom = clamp(transform.zoom * zoomFactor, 1, 5);
                    updateItemTransform(activeItem, index);
                    initialPinchDistance = newPinchDistance;
                }
            });

            document.addEventListener('mouseup', () => {
                if(activeItem) activeItem.classList.remove('is-dragging');
                isDragging = false;
                activeItem = null;
            });

             document.addEventListener('touchend', () => {
                if(activeItem) activeItem.classList.remove('is-dragging');
                isDragging = false;
                initialPinchDistance = 0;
                activeItem = null;
            });

            collageContainer.addEventListener('wheel', e => {
                if (e.target.classList.contains('collage-item')) {
                    e.preventDefault();
                    const item = e.target;
                    const index = parseInt(item.dataset.index, 10);
                    const transform = imageTransforms[index];
                    const scaleAmount = 0.05;
                    transform.zoom = clamp(transform.zoom - e.deltaY * scaleAmount, 1, 5);
                    updateItemTransform(item, index);
                }
            });

            // --- Event Listeners & Initial Setup ---
            imageUpload.addEventListener('change', handleImageUpload);
            spacingSlider.addEventListener('input', applyStyles);
            radiusSlider.addEventListener('input', applyStyles);
            colorPicker.addEventListener('input', applyStyles);
            downloadBtn.addEventListener('click', downloadCollage);
            scaleSlider.addEventListener('input', () => {
                scaleValue.textContent = `${scaleSlider.value}x`;
            });

            initLayoutButtons();
            initAspectRatioButtons();
            applyAspectRatio();
            renderCollage();
        });
    </script>
</body>
</html>
